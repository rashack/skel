#!/bin/bash

set -o nounset

OS_ID=$(source /etc/os-release ; echo $ID)

textwidth() {
    TEXT="$1"
    case $OS_ID in
        arch)
            echo $(( ${#TEXT} * 8 ))
            ;;
        debian|linuxmint)
            dzen2-textwidth $DZEN_FONT "$TEXT"
            ;;
    esac
}

laptop_variables() {
    CONKY_EXTRA="\${lua lc_n battery_percent Bat}"
    CONKY_SSID="\${execpi 60 sh ~/bin/active-ssid.sh}"
}


case $OS_ID in
    arch|linuxmint)
        DZEN_FONT="-*-terminus-*-*-*-*-14-*-*-*-*-*-iso8859-*" ;;
    *)
        DZEN_FONT="-misc-fixed-medium-r-semicondensed-*-13-120-75-75-c-60-iso8859-*";;
esac

CONKY_EXTRA=''
CONKY_SSID=''

# xrandr | grep '*' | awk '{print $1}' | cut -d x -f 1
SCREEN_WIDTH=$(xdpyinfo | grep 'dimensions:' | awk '{print $2}' | cut -d x -f 1)
# leave some room for stalonetray
SCREEN_WIDTH=$(( $SCREEN_WIDTH - 34 ))
STATUS_Y_POS=0

case $(hostname) in
    chimp)
        # xrandr --output DP-1 --mode 2560x1440 --rotate normal --output DP-2 --pos 2560x0 --mode 2560x1440 --rotate left
        # xrandr --output DP-1 --mode 2560x1440 --output DP-2 --pos 2560x0    --mode 2560x1440 --rotate left
        # when
        # xrandr --output DP-1 --mode 2560x1440 --output DP-2 --pos 2560x-560 --mode 2560x1440 --rotate left
        # the following is needed (because the top of the left screen is shifted by 560 = (2560-1440)/2)
        # STATUS_Y_POS=560
        ;;
    tp|bluetang|tubarao)
        laptop_variables
        ;;
esac

DZEN_TIMEBAR_WIDTH=$(textwidth "Day wNN YYYY-mm-dd HH:MM:SS    ")
DZEN_TIMEBAR_WIDTH=$(textwidth "Day wNN YYYY-mm-dd HH:MM:SS")
DZEN_IDLE_WIDTH=$(textwidth "<SSS>")

case $OS_ID in
    arch|linuxmint)
    ;;
    debian)
        DZEN_TIMEBAR_WIDTH=$(( $DZEN_TIMEBAR_WIDTH + 16 ))
        DZEN_IDLE_WIDTH=$(( $DZEN_IDLE_WIDTH + 16 ))
        ;;
esac

CONKY_IF=$(ip r | sed -n 's/default via.*dev \([^ ]*\).*/\1/ p')
CONKY_CPU="\${lua lc cpu CPU}"
CONKY_MEM="\${lua lc memperc Mem}"
CONKY_SWP="Swap:\${swapperc}"
CONKY_NET="$CONKY_IF:\${upspeed $CONKY_IF}/\${downspeed $CONKY_IF} [$CONKY_SSID]"
CONKY_LOAD_STR="$CONKY_CPU $CONKY_MEM $CONKY_SWP $CONKY_EXTRA $CONKY_NET"

DZEN_IDLE_X=$DZEN_TIMEBAR_WIDTH
DZEN_STATUS_X=$(( $DZEN_IDLE_X + $DZEN_IDLE_WIDTH ))
if [ '' == "$CONKY_EXTRA" ] ; then
    DZEN_LOAD_WIDTH=$(textwidth "CPU:100 Mem:100 Swap:100 $CONKY_IF: 0.1234KiB/0.1234KiB")
else
    DZEN_LOAD_WIDTH=$(textwidth "CPU:100 Mem:100 Swap:100 Bat: $CONKY_IF: 0.1234KiB/0.1234KiB [active-SSID]")
fi
DZEN_STATUS_WIDTH=$(( $SCREEN_WIDTH - $DZEN_STATUS_X - $DZEN_LOAD_WIDTH ))
DZEN_LOAD_X=$(( $SCREEN_WIDTH - $DZEN_LOAD_WIDTH ))
DZEN_OPTS="-y $STATUS_Y_POS -fn $DZEN_FONT -bg #044084"
#DZEN_OPTS="-fn $DZEN_FONT -bg #044084"

export DZEN_FONT
export DZEN_OPTS
export DZEN_TIMEBAR_WIDTH
export DZEN_IDLE_X
export DZEN_IDLE_WIDTH
export DZEN_STATUS_X
export DZEN_STATUS_WIDTH
export DZEN_LOAD_X
export DZEN_LOAD_WIDTH
export CONKY_IF
export CONKY_SSID
export CONKY_EXTRA
export CONKY_LOAD_STR
